<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>Book of Sclavin: AR</title>
    <meta name="description" content="AR web app for Book of Sclavin interactive book">
    <meta name="author" content="kvaba.com">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
    <script src="src/aframe-extras.min.js"></script>
    <script src="src/jsQR.js"></script>
    <link rel="stylesheet" href="css/style.css">
    
    <script>
        AFRAME.registerComponent('qr-manager', {
            init: function () {
                this.el.sceneEl.addEventListener('markerFound', function () {
                    markerVisibilityFlag = true;
                    console.log("marker found");
                });
                this.el.sceneEl.addEventListener('markerLost', function () {
                    document.querySelector("a-marker").object3D.visible = true;
                    markerVisibilityFlag = false;
                    setTimeout(function () {
                        if (markerVisibilityFlag == false) document.querySelector("a-marker").object3D.visible = false;
                        if (markerVisibilityFlag == true) document.querySelector("a-marker").object3D.visible = true;
                    }, 1500)
                    
                });
            }
        });
    </script>
</head>

<body>
    <button id="qr-snap" onclick="scanQR()">snap</button>
    <a-scene logarythmic-renderer embedded arjs="debugUIEnabled: false; detectionMode: mono; patternRatio: 0.7;"
    vr-mode-ui="enabled: false"
    renderer="gammaOutput: true, gammaFactor: 2.2"
    light="defaultLightsEnabled: false"
    stats>
    <a-marker type='pattern' url='marker/pattern-qr-code-cokesummer-lar-li-07.patt'>
        <a-entity id="qr-manager" qr-manager></a-entity>
        <a-box></a-box>
    </a-marker>
    
    <a-entity light="type:point; castShadow:true; intensity: 1.2" position="1 5 1"></a-entity>
    
    <a-entity camera></a-entity>
</a-scene>

<canvas id="canvas-tmp" width="640" height="480" ></canvas>
<div id="info">info</div>
<script>
    var qrContent = '';
    var markerVisibilityFlag = false;
    var canvasTmp = document.getElementById("canvas-tmp");
    var canvasTmpCtx = canvasTmp.getContext("2d");
    var arjsVideo;
    var info = document.getElementById("info");
    
    function scanQR() {        
        canvasTmpCtx.drawImage(arjsVideo, 0, 0, canvasTmp.width, canvasTmp.height)
        //var imageData = canvasTmpCtx.getImageData(0, 0, 640, 480);
        var decoded = jsQR(canvasTmpCtx.getImageData(0, 0, 640, 480).data, 640, 480);
        if (decoded) {
            console.log(decoded.data)
            info.innerHTML = decoded.data;
            qrContent = decoded.data;
        } else {
            info.innerHTML = 'no code found';
            setTimeout(function() {
                scanQR();
            },100);
        }
    }
    

    // DETECT WHEN VIDEO IS INSERTED AND SET IT TO A VARIABLE
    var mutationObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes[0].id == 'arjs-video') {
                // console.log(mutation.addedNodes[0].id)
                mutationObserver.disconnect();
                arjsVideo = document.querySelector('video');
                // console.log(arjsVideo);
            }
        });
    });
    mutationObserver.observe(document.documentElement, {
        attributes: false,
        characterData: false,
        childList: true,
        subtree: true,
        attributeOldValue: false,
        characterDataOldValue: false
    });
    
    
    // AFRAME COMPONENTS    
    AFRAME.registerComponent('logarythmic-renderer', {
        init: function () {
            this.el.renderer.capabilities.logarithmicDepthBuffer=true
            // console.log('Renderer ' ,this.el.renderer);
        }
    });
</script>
</body>
</html>