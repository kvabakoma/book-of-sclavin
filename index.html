<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>Book of Sclavin: AR</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="AR web app for Book of Sclavin interactive book">
    <meta name="author" content="kvaba.com">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
    <script src="src/aframe-gif-shader.min.js"></script>
    <script src="src/aframe-extras.min.js"></script>
    <script src="src/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mobile-detect/1.4.3/mobile-detect.min.js"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <script>
        AFRAME.registerComponent('qr-manager', {
            init: function () {
                
                //gifRef = document.getElementById('current-gif');
                loadedGifs = [document.getElementById('gif0'),document.getElementById('gif1'),document.getElementById('gif2')]
                //console.log(document.getElementById("gif1").getAttribute('material').split("/").pop().split(".").shift())
                
                this.el.sceneEl.addEventListener('markerFound', function () {
                    if (!markerVisibilityFlag) scanQR();
                    markerVisibilityFlag = true;                    
                });
                
                this.el.sceneEl.addEventListener('markerLost', function () {
                    document.querySelector("a-marker").object3D.visible = true;
                    markerVisibilityFlag = false;
                    qrVisibilityFlag = false;
                    setTimeout(function () {
                        if (markerVisibilityFlag == false) {
                            document.querySelector("a-marker").object3D.visible = false;
                            info.innerHTML = 'marker lost';  
                            //gifRef.setAttribute('visible', false);    
                            for(i=0;i<loadedGifs.length;i++){
                                loadedGifs[i].setAttribute('visible', false);  
                            }
                            overlay.classList.remove("d-none");   
                            //gifRef.setAttribute('material', 'src', 'url()');                   
                        }
                        if (markerVisibilityFlag == true) document.querySelector("a-marker").object3D.visible = true;
                    }, 500)
                    
                });
                
            }
        });
    </script>
    
    <script>
        var md = new MobileDetect(window.navigator.userAgent);
        if (!md.mobile()) {
            console.log("desktop")
            window.location.href = "error.html?err=desktop";
        } else {
            if (md.is('iPhone') || md.is('iPad')) {
                if (md.userAgent() != "Safari") {
                    window.location.href = "error.html?err=ios";
                }
            } else {
                if (md.userAgent() != "Chrome") {
                    window.location.href = "error.html?err=android";
                }
            }
        }
    </script>
</head>

<body>
    <button id="qr-snap" onclick="scanQR()">snap</button>
    <a-scene embedded arjs="debugUIEnabled: false; detectionMode: mono; patternRatio: 0.7;"
    vr-mode-ui="enabled: false"
    renderer="gammaOutput: true, gammaFactor: 2.2"
    light="defaultLightsEnabled: false"
    >
    
    <a-assets>
        <a-asset-item id="1" src="assets/images/1.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="2" src="assets/images/2.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="3" src="assets/images/3.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="4" src="assets/images/4.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="5" src="assets/images/5.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="6" src="assets/images/6.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="7" src="assets/images/7.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="8" src="assets/images/8.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="9" src="assets/images/9.gif" crossOrigin="anonymous"></a-asset-item>
        <!-- <a-asset-item id="10" src="assets/images/10.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="11" src="assets/images/11.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="12" src="assets/images/12.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="13" src="assets/images/13.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="14" src="assets/images/14.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="15" src="assets/images/15.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="16" src="assets/images/16.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="17" src="assets/images/17.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="18" src="assets/images/18.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="19" src="assets/images/19.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="20" src="assets/images/20.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="21" src="assets/images/21.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="22" src="assets/images/22.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="23" src="assets/images/23.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="24" src="assets/images/24.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="25" src="assets/images/25.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="26" src="assets/images/26.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="27" src="assets/images/27.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="28" src="assets/images/28.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="29" src="assets/images/29.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="30" src="assets/images/30.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="31" src="assets/images/31.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="32" src="assets/images/32.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="33" src="assets/images/33.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="34" src="assets/images/34.gif" crossOrigin="anonymous"></a-asset-item>
        <a-asset-item id="35" src="assets/images/35.gif" crossOrigin="anonymous"></a-asset-item> -->
    </a-assets>
    
    <a-marker type='pattern' url='marker/pattern-qr-code-cokesummer-lar-li-07.patt'>
        <a-entity id="qr-manager" qr-manager></a-entity>
        <!-- <a-plane id="loader" position="0 .1 0" rotation="-90 0 0" width="1.2" height="1.2" material="shader:gif;src:url(assets/images/LOADER.gif);"></a-plane> -->
        <a-plane id="gif0" gifId="3" position="0 0 0" rotation="-90 0 0" width="1.2" height="1.2" material="shader:gif;src:url(assets/images/3.gif);" visible="false"></a-plane>
        <a-plane id="gif1" gifId="4" position="0 0 0" rotation="-90 0 0" width="1.2" height="1.2" material="shader:gif;src:url(assets/images/4.gif);" visible="false"></a-plane>
        <a-plane id="gif2" gifId="5" position="0 0 0" rotation="-90 0 0" width="1.2" height="1.2" material="shader:gif;src:url(assets/images/5.gif);" visible="false"></a-plane>
    </a-marker>
    
    <a-entity light="type:point; castShadow:true; intensity: 1.2" position="1 5 1"></a-entity>
    
    <a-entity camera></a-entity>
    
    <div id="overlay">
        <p>
            Насочете камерата към маркера
        </p>
    </div>
    
</a-scene>

<canvas id="canvas-tmp" width="640" height="480" ></canvas>
<div id="info">info</div>

<script>
    var qrContent = '';
    var markerVisibilityFlag = false;
    var qrVisibilityFlag = false;
    var canvasTmp = document.getElementById("canvas-tmp");
    var canvasTmpCtx = canvasTmp.getContext("2d");
    var arjsVideo;
    var overlay = document.getElementById('overlay');
    var info = document.getElementById("info");
    var loadedGifs = [];
    
    function scanQR() {   
        if (qrVisibilityFlag) return // don't read QR if the AR is not located
        console.log("scanning for QR")
        
        canvasTmpCtx.drawImage(arjsVideo, 0, 0, canvasTmp.width, canvasTmp.height)
        //var imageData = canvasTmpCtx.getImageData(0, 0, 640, 480);
        var decoded = jsQR(canvasTmpCtx.getImageData(0, 0, 640, 480).data, 640, 480, {inversionAttempts:'dontInvert'});
        if (decoded) {
            qrContent = decoded.data.split("/").pop();
            info.innerHTML = qrContent;
            qrVisibilityFlag = true;
            
            var isLoaded = checkGifLoaded(qrContent);
            
            if (isLoaded != false)  {               // 1. if exists -> show()
                console.log("in exists")
                showGif(isLoaded);
                reloadGifs(qrContent,isLoaded);
            } else {                                // 2. if not exists -> load and show()
                console.log("in does not exist");
                loadedGifs[1].setAttribute('material', 'src', 'url(assets/images/'+qrContent+'.gif)'); 
                loadedGifs[1].setAttribute('gifId', qrContent);
                showGif(isLoaded);
                reloadGifs(qrContent,isLoaded);
            }
            overlay.classList.add("d-none");
        } else {
            info.innerHTML = 'no code found';
            setTimeout(function() {
                console.log('delayed call')
                if (markerVisibilityFlag) scanQR();
            },100);
        }
    }    
    
    // DETECT WHEN VIDEO IS INSERTED AND SET IT TO A VARIABLE
    var mutationObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes[0].id == 'arjs-video') {
                mutationObserver.disconnect();
                arjsVideo = document.querySelector('video');
            }
        });
    });
    
    mutationObserver.observe(document.documentElement, {
        attributes: false,
        characterData: false,
        childList: true,
        subtree: true,
        attributeOldValue: false,
        characterDataOldValue: false
    });
    
    function checkGifLoaded(qrId) {
        console.log("in checkGifLoaded", qrId)
        for (i = 0; i < loadedGifs.length;  i++) {
            if (loadedGifs[i].getAttribute('gifId') == qrId) return i;
        }        
        return false;
    }
    
    function showGif(index) {
        console.log("in showGif",index);
        loadedGifs[index].setAttribute("visible", true);
    }
    
    function reloadGifs(qrId, index) {
        console.log("reloadGifs",index);
        var v = [+qrId-1, +qrId+1];
        for (i = 0; i < loadedGifs.length;  i++) {
            if (i != index) {
                var id = v.pop()
                loadedGifs[i].setAttribute('material', 'src', 'url(assets/images/'+id+".gif)"); 
                loadedGifs[i].setAttribute('gifId', id);
            }
            console.log(loadedGifs[i].getAttribute('gifId'))
        }
    }
    
    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
    }
</script>
</body>
</html>